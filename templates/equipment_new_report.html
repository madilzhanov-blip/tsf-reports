{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π —Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç{% endblock %}

{% block content %}
<div class="card">
    <h2>üìù –ù–æ–≤—ã–π —Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ</h2>
    <p style="color: #666; margin-bottom: 30px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É —Ç–µ—Ö–Ω–∏–∫–∏</p>
    
    <form method="POST" id="equipmentForm">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="form-row-3">
            <div class="form-group">
                <label for="date">–î–∞—Ç–∞ —Å–º–µ–Ω—ã *</label>
                <input type="date" id="date" name="date" required>
            </div>
            
            <div class="form-group">
                <label for="shift">–°–º–µ–Ω–∞ *</label>
                <select id="shift" name="shift" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É</option>
                    <option value="–î–µ–Ω—å">üåÖ –î–µ–Ω—å (06:00-18:00)</option>
                    <option value="–ù–æ—á—å">üåô –ù–æ—á—å (18:00-06:00)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="inspector_name">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä *</label>
                <input type="text" id="inspector_name" name="inspector_name" 
                       value="{{ session.full_name }}" required>
            </div>
        </div>
        
        <!-- –î–∞–Ω–Ω—ã–µ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ -->
        <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">üöú –î–∞–Ω–Ω—ã–µ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ</h3>
        
        <div id="equipmentData">
            {% for equipment_type, info in equipment_types.items() %}
            <div class="equipment-section">
                <h4 style="background: #f8f9fa; padding: 15px; margin: 20px 0 0 0; border-radius: 5px;">
                    {{ equipment_type }} 
                    <small style="color: #666;">(–º–∞–∫—Å. {{ info.max_count }} {{ info.unit }})</small>
                </h4>
                
                <div class="form-row-4">
                    <div class="form-group">
                        <label>–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ</label>
                        <input type="number" name="available_{{ loop.index0 }}" 
                               max="{{ info.max_count }}" min="0" 
                               onchange="calculateEfficiency({{ loop.index0 }})"
                               placeholder="0">
                        <input type="hidden" name="type_{{ loop.index0 }}" value="{{ equipment_type }}">
                    </div>
                    
                    <div class="form-group">
                        <label>–í —Ä–∞–±–æ—Ç–µ</label>
                        <input type="number" name="working_{{ loop.index0 }}" 
                               min="0" onchange="calculateEfficiency({{ loop.index0 }})"
                               placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label>–í –æ–∂–∏–¥–∞–Ω–∏–∏</label>
                        <input type="number" name="waiting_{{ loop.index0 }}" 
                               min="0" placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label>–í —Ä–µ–º–æ–Ω—Ç–µ</label>
                        <input type="number" name="repair_{{ loop.index0 }}" 
                               min="0" placeholder="0">
                    </div>
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label>–ë–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞</label>
                        <input type="number" name="no_operator_{{ loop.index0 }}" 
                               min="0" placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–µ—Ç —Ç–æ–ø–ª–∏–≤–∞</label>
                        <input type="number" name="no_fuel_{{ loop.index0 }}" 
                               min="0" placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                        <input type="text" id="efficiency_{{ loop.index0 }}" 
                               readonly style="background: #f8f9fa; font-weight: bold;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–ù–∞ –¥–∞–º–±–µ</label>
                        <input type="number" name="on_dam_{{ loop.index0 }}" 
                               min="0" placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label>–û—Å–Ω–æ–≤–Ω–æ–π —É—á–∞—Å—Ç–æ–∫ —Ä–∞–±–æ—Ç</label>
                        <select name="location_{{ loop.index0 }}">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫</option>
                            {% for location in work_locations %}
                            <option value="{{ location }}">{{ location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                    <textarea name="comments_{{ loop.index0 }}" rows="2" 
                              placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–∏–º–µ—á–∞–Ω–∏—è..."></textarea>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- –û–±—â–∏–µ –∏—Ç–æ–≥–∏ -->
        <div style="background: #e3f2fd; padding: 20px; border-radius: 5px; margin: 30px 0;">
            <h3 style="color: #1565c0; margin-bottom: 15px;">üìä –û–±—â–∏–µ –∏—Ç–æ–≥–∏</h3>
            <div class="form-row-4">
                <div>
                    <strong>–í—Å–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ:</strong> 
                    <span id="totalAvailable" style="font-size: 1.2em; color: #1565c0;">0</span>
                </div>
                <div>
                    <strong>–í —Ä–∞–±–æ—Ç–µ:</strong> 
                    <span id="totalWorking" style="font-size: 1.2em; color: #2e7d32;">0</span>
                </div>
                <div>
                    <strong>–û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> 
                    <span id="totalEfficiency" style="font-size: 1.2em; color: #ed6c02;">0%</span>
                </div>
                <div>
                    <strong>–ü—Ä–æ—Å—Ç–æ–∏:</strong> 
                    <span id="totalDowntime" style="font-size: 1.2em; color: #d32f2f;">0</span>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" class="btn btn-success" style="flex: 1;">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
            </button>
            <a href="/equipment" class="btn btn-secondary" style="flex: 0 0 200px;">
                üîô –ö –¥–∞—à–±–æ—Ä–¥—É
            </a>
        </div>
    </form>
</div>

<script>
// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ —Ç–µ—Ö–Ω–∏–∫–∏
const equipmentCount = {{ equipment_types|length }};

function calculateEfficiency(index) {
    const available = parseInt(document.querySelector(`[name="available_${index}"]`).value) || 0;
    const working = parseInt(document.querySelector(`[name="working_${index}"]`).value) || 0;
    
    const efficiency = available > 0 ? Math.round((working / available) * 100) : 0;
    document.getElementById(`efficiency_${index}`).value = `${efficiency}%`;
    
    updateTotals();
}

function updateTotals() {
    let totalAvailable = 0;
    let totalWorking = 0;
    
    for (let i = 0; i < equipmentCount; i++) {
        totalAvailable += parseInt(document.querySelector(`[name="available_${i}"]`).value) || 0;
        totalWorking += parseInt(document.querySelector(`[name="working_${i}"]`).value) || 0;
    }
    
    const totalEfficiency = totalAvailable > 0 ? Math.round((totalWorking / totalAvailable) * 100) : 0;
    const totalDowntime = totalAvailable - totalWorking;
    
    document.getElementById('totalAvailable').textContent = totalAvailable;
    document.getElementById('totalWorking').textContent = totalWorking;
    document.getElementById('totalEfficiency').textContent = `${totalEfficiency}%`;
    document.getElementById('totalDowntime').textContent = totalDowntime;
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è
document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ–Ω—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏
    const currentHour = new Date().getHours();
    const shiftSelect = document.getElementById('shift');
    if (currentHour >= 6 && currentHour < 18) {
        shiftSelect.value = '–î–µ–Ω—å';
    } else {
        shiftSelect.value = '–ù–æ—á—å';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', updateTotals);
    });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
document.getElementById('equipmentForm').addEventListener('submit', function(e) {
    let hasErrors = false;
    const errors = [];
    
    for (let i = 0; i < equipmentCount; i++) {
        const available = parseInt(document.querySelector(`[name="available_${i}"]`).value) || 0;
        const working = parseInt(document.querySelector(`[name="working_${i}"]`).value) || 0;
        const equipmentType = document.querySelector(`[name="type_${i}"]`).value;
        
        if (working > available && available > 0) {
            errors.push(`${equipmentType}: –í —Ä–∞–±–æ—Ç–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ`);
            hasErrors = true;
        }
    }
    
    if (hasErrors) {
        e.preventDefault();
        alert('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:\n\n' + errors.join('\n'));
    }
});
</script>

<style>
.equipment-section {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 15px;
    transition: border-color 0.3s;
}

.equipment-section:hover {
    border-color: #3498db;
}

.form-row-4 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 15px;
}

.form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

@media (max-width: 768px) {
    .form-row-4,
    .form-row-3,
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}