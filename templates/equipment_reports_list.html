{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ{% endblock %}

{% block content %}
<div class="card">
    <h2>üìã –û—Ç—á–µ—Ç—ã –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ</h2>
    <p style="color: #666; margin-bottom: 30px;">–ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</p>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 15px;">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
        <form method="GET" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>–î–∞—Ç–∞ –æ—Ç:</label>
                <input type="date" name="date_from" value="{{ current_date_from }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>–î–∞—Ç–∞ –¥–æ:</label>
                <input type="date" name="date_to" value="{{ current_date_to }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>–°–º–µ–Ω–∞:</label>
                <select name="shift">
                    <option value="">–í—Å–µ —Å–º–µ–Ω—ã</option>
                    <option value="–î–µ–Ω—å" {{ 'selected' if current_shift == '–î–µ–Ω—å' else '' }}>–î–µ–Ω—å</option>
                    <option value="–ù–æ—á—å" {{ 'selected' if current_shift == '–ù–æ—á—å' else '' }}>–ù–æ—á—å</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="/equipment/reports" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </form>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="/equipment/new_report" class="btn btn-success">‚ûï –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</a>
        <a href="/equipment/export{% if current_date_from or current_date_to or current_shift %}?{% if current_date_from %}date_from={{ current_date_from }}{% endif %}{% if current_date_to %}&date_to={{ current_date_to }}{% endif %}{% if current_shift %}&shift={{ current_shift }}{% endif %}{% endif %}" 
           class="btn btn-warning">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
    </div>
    
    {% if reports %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°–º–µ–Ω–∞</th>
                    <th>–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</th>
                    <th>–í—Å–µ–≥–æ —Ç–µ—Ö–Ω–∏–∫–∏</th>
                    <th>–í —Ä–∞–±–æ—Ç–µ</th>
                    <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–í —Ä–µ–º–æ–Ω—Ç–µ</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td><strong>{{ report.id }}</strong></td>
                    <td>{{ report.date }}</td>
                    <td>
                        <span class="badge badge-{{ 'warning' if report.shift == '–î–µ–Ω—å' else 'info' }}">
                            {{ 'üåÖ' if report.shift == '–î–µ–Ω—å' else 'üåô' }} {{ report.shift }}
                        </span>
                    </td>
                    <td>{{ report.inspector_name }}</td>
                    <td>{{ report.totals.total_available }}</td>
                    <td>{{ report.totals.total_working }}</td>
                    <td>
                        <span class="badge badge-{% if report.totals.efficiency_percent >= 70 %}success{% elif report.totals.efficiency_percent >= 50 %}warning{% else %}danger{% endif %}">
                            {{ report.totals.efficiency_percent }}%
                        </span>
                    </td>
                    <td>{{ report.totals.total_repair }}</td>
                    <td>{{ report.created_at.split(' ')[1][:5] if ' ' in report.created_at else report.created_at }}</td>
                    <td>
                        <a href="/equipment/report/{{ report.id }}" class="btn btn-info btn-sm">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        <a href="/equipment/report/{{ report.id }}/edit" class="btn btn-primary btn-sm">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</a>
                        <button onclick="deleteReport({{ report.id }})" class="btn btn-danger btn-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4>üì≠ –û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ.</p>
        <a href="/equipment/new_report" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç</a>
    </div>
    {% endif %}
</div>

<script>
function deleteReport(reportId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?')) {
        fetch(`/equipment/report/${reportId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + result.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });
    }
}
</script>

<style>
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge-success { background: #28a745; color: white; }
.badge-warning { background: #ffc107; color: black; }
.badge-danger { background: #dc3545; color: white; }
.badge-info { background: #17a2b8; color: white; }

.table-container {
    overflow-x: auto;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    padding: 20px;
    border-radius: 5px;
    text-align: center;
}
</style>
{% endblock %}