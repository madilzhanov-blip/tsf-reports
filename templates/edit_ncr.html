{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NCR{% endblock %}

{% block content %}
<div class="card">
    <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ #{{ ncr.id }}</h2>
    <p style="color: #666; margin-bottom: 30px;">–ù–æ–º–µ—Ä NCR: {{ ncr.NCR_Number }}</p>
    
    <form method="POST" enctype="multipart/form-data">
        <h3 style="margin-bottom: 20px; color: #2c3e50;">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        
        <div class="form-group">
            <label for="NCR_Number">1. –ù–æ–º–µ—Ä NCR</label>
            <input type="text"
       name="NCR_Number"
       value="{{ ncr.NCR_Number }}"
       readonly>
        </div>

        <div class="form-group">
    <label>–ü—Ä–æ–µ–∫—Ç</label>
    <select name="Project" class="form-select">
        <option value="">‚Äî 2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç ‚Äî</option>

        <option value="–û—Å–≤–æ–µ–Ω–∏—è –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è –ï—à–ª–∏–∫-1 –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–µ–¥–Ω–æ-–æ–±–æ–≥–∞—Ç–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏ (–ú–û–§-3) —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞"
            {{ 'selected' if ncr.Project == '–û—Å–≤–æ–µ–Ω–∏—è –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è –ï—à–ª–∏–∫-1 –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–µ–¥–Ω–æ-–æ–±–æ–≥–∞—Ç–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏ (–ú–û–§-3) —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.–•–≤–æ—Å—Ç–æ–≤–æ–µ –•–æ–∑—è–π—Å—Ç–≤–æ –ö–∞—Ä—Ç–∞ ‚Ññ1' else '' }}>
            –û—Å–≤–æ–µ–Ω–∏—è –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è –ï—à–ª–∏–∫-1 –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–µ–¥–Ω–æ-–æ–±–æ–≥–∞—Ç–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏ (–ú–û–§-3) —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.–•–≤–æ—Å—Ç–æ–≤–æ–µ –•–æ–∑—è–π—Å—Ç–≤–æ –ö–∞—Ä—Ç–∞ ‚Ññ1
        </option>

        <option value="–î—Ä—É–≥–æ–µ" {{ 'selected' if ncr.Project == '–î—Ä—É–≥–æ–µ' else '' }}>
            –î—Ä—É–≥–æ–µ
        </option>
    </select>
</div>
        <div class="form-group">
            <label for="Discipline">3. –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ *</label>
            <select id="Discipline" name="Discipline" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</option>
                <option value="CIV" {{ 'selected' if ncr.Discipline == 'CIV' else '' }}>CIV</option>
                <option value="ELE" {{ 'selected' if ncr.Discipline == 'ELE' else '' }}>ELE</option>
                <option value="PIP" {{ 'selected' if ncr.Discipline == 'PIP' else '' }}>PIP</option>
                <option value="CCTV" {{ 'selected' if ncr.Discipline == 'CCTV' else '' }}>CCTV</option>
                <option value="INS" {{ 'selected' if ncr.Discipline == 'INS' else '' }}>INS</option>
                <option value="STS" {{ 'selected' if ncr.Discipline == 'STS' else '' }}>STS</option>
            </select>
        </div>
    <div class="form-group">
    <label>4. –ö–æ–º—É –≤—ã–¥–∞–Ω–æ</label>
    <input type="text" name="Contractor"
           value="{{ ncr.Contractor or '' }}">
</div>

<div class="form-group">
    <label>5. –ö–µ–º –≤—ã–¥–∞–Ω–æ</label>
    <input type="text" name="technical_supervisor_company"
           value="{{ ncr.technical_supervisor_company or '' }}">
</div>    
        <div class="form-group">
            <label for="major_object">6. –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ *</label>
            <select id="major_object" name="major_object" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</option>
                <option value="–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥–∞ —Ö–≤–æ—Å—Ç–æ–≤ –∫–∞—Ä—Ç—ã 1" {{ 'selected' if ncr.major_object == '–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥–∞ —Ö–≤–æ—Å—Ç–æ–≤ –∫–∞—Ä—Ç—ã 1' else '' }}>–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥–∞ —Ö–≤–æ—Å—Ç–æ–≤ –∫–∞—Ä—Ç—ã 1</option>
                <option value="–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥" {{ 'selected' if ncr.major_object == '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥' else '' }}>–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—É–ª—å–ø–æ–≤–æ–¥</option>
                <option value="–ü–ª–æ—â–∞–¥–∫–∞ –ø–æ–¥—Å—Ç–∞–Ω—Ü–∏–∏ –ì–ü–ü-1 110/10–∫–í. –ì–ü–ü-1 –ü–° 110/6 –∫–í - 2—Ö10000" {{ 'selected' if ncr.major_object == '–ü–ª–æ—â–∞–¥–∫–∞ –ø–æ–¥—Å—Ç–∞–Ω—Ü–∏–∏ –ì–ü–ü-1 110/10–∫–í. –ì–ü–ü-1 –ü–° 110/6 –∫–í - 2—Ö10000' else '' }}>–ü–ª–æ—â–∞–¥–∫–∞ –ø–æ–¥—Å—Ç–∞–Ω—Ü–∏–∏ –ì–ü–ü-1 110/10–∫–í. –ì–ü–ü-1 –ü–° 110/6 –∫–í - 2—Ö10000</option>
                <option value="–ü–∏–æ–Ω–µ—Ä–Ω–∞—è –¥–∞–º–±–∞" {{ 'selected' if ncr.major_object == '–ü–∏–æ–Ω–µ—Ä–Ω–∞—è –¥–∞–º–±–∞' else '' }}>–ü–∏–æ–Ω–µ—Ä–Ω–∞—è –¥–∞–º–±–∞</option>
                <option value="–£—á–∞—Å—Ç–æ–∫ –≤–æ–¥–æ–∑–∞–±–æ—Ä–∞" {{ 'selected' if ncr.major_object == '–£—á–∞—Å—Ç–æ–∫ –≤–æ–¥–æ–∑–∞–±–æ—Ä–∞' else '' }}>–£—á–∞—Å—Ç–æ–∫ –≤–æ–¥–æ–∑–∞–±–æ—Ä–∞</option>
                <option value="–î—Ä—É–≥–æ–µ" {{ 'selected' if ncr.major_object == '–î—Ä—É–≥–æ–µ' else '' }}>–î—Ä—É–≥–æ–µ</option>
            </select>
        </div>
<div class="form-group">
    <label>7. –ù–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞</label>
    <input type="text" name="Draw_number"
       value="{{ ncr.Draw_number or '' }}">
</div> 
        
        <div class="form-group">
            <label for="Location">8. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤ / —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ / —É—á–∞—Å—Ç–æ–∫</label>
            <input type="text" id="Location" name="Location" 
                   value="{{ ncr.Location }}" required
                   placeholder="–§—É–Ω–¥–∞–º–µ–Ω—Ç –§–ú-2,–°–µ–≤–µ—Ä–Ω–∞—è –¥–∞–º–±–∞">
        </div>
      <div class="form-group">
            <label for="Procedure">9. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞</label>
            <input type="text" id="Procedure" name="Procedure" 
                   value="{{ ncr.Procedure }}" 
                   placeholder="–ü—É–Ω–∫—Ç—ã –®–ù–ö/–ü–ü–†">
        </div>


        <div class="form-group">
            <label for="NCR_Description">10. –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</label>
            <input type="text" id="NCR_Description" name="NCR_Description" 
                   value="{{ ncr.NCR_Description }}" required
                   placeholder="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è">
        </div>
        
        <div class="form-group">
            <label for="NCR_grade">11. –û—Ü–µ–Ω–∫–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å–≤–∏—è *</label>
            <select id="NCR_grade" name="NCR_grade" required>
                <option value="">–û—Ü–µ–Ω–∏—Ç–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å–≤–∏—è</option>
                <option value="–û—á–µ–Ω—å –≤–∞–∂–Ω—ã–π" {{ 'selected' if ncr.NCR_grade == '–û—á–µ–Ω—å –≤–∞–∂–Ω—ã–π' else '' }}>–û—á–µ–Ω—å –≤–∞–∂–Ω—ã–π</option>
                <option value="–ù–µ–æ—Ç–ª–æ–∂–Ω—ã–π" {{ 'selected' if ncr.NCR_grade == '–ù–µ–æ—Ç–ª–æ–∂–Ω—ã–π' else '' }}>–ù–µ–æ—Ç–ª–æ–∂–Ω—ã–π</option>
                <option value="–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π" {{ 'selected' if ncr.NCR_grade == '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π' else '' }}>–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π</option>
                <option value="–ù–µ—Å—Ä–æ—á–Ω—ã–π" {{ 'selected' if ncr.NCR_grade == '–ù–µ—Å—Ä–æ—á–Ω—ã–π' else '' }}>–ù–µ—Å—Ä–æ—á–Ω—ã–π</option>
                <option value="–î—Ä—É–≥–æ–µ" {{ 'selected' if ncr.NCR_grade == '–î—Ä—É–≥–æ–µ' else '' }}>–î—Ä—É–≥–æ–µ</option>
            </select>
        </div>


        <div class="form-group">
            <label for="inspection_date">12. –î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞ *</label>
            <input type="date"
       id="inspection_date"
       name="inspection_date"
       value="{{ ncr.inspection_date }}">

        </div>
        
        <div class="form-group">
            <label for="Correction_acts">13. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ü–æ–¥—Ä—è–¥—á–∏–∫–∞</label>
            <input type="text" id="Correction_acts" name="Correction_acts" 
                   value="{{ ncr.Correction_acts }}" 
                   placeholder="–£–∫–∞–∑–∞–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π">
        </div>
        
         

        <div class="form-group">
            <label for="closed_date.plan">14. –°—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è *</label>
            <input type="date"
       id="closed_date.plan"
       name="closed_date.plan"
       value="{{ ncr.get('closed_date.plan','') }}">

        </div>           
        
        <div class="form-group">
            <label for="NCR_grade">15. –ú–µ—Ä—ã *</label>
            <select id="Measures" name="Measures" required>
                <option value="–î–æ—Ä–∞–±–æ—Ç–∫–∞" {{ 'selected' if ncr.Measures == '–î–æ—Ä–∞–±–æ—Ç–∫–∞' else '' }}>–î–æ—Ä–∞–±–æ—Ç–∫–∞</option>
                <option value="–†–µ–º–æ–Ω—Ç" {{ 'selected' if ncr.Measures == '–†–µ–º–æ–Ω—Ç' else '' }}>–†–µ–º–æ–Ω—Ç</option>
                <option value="–û—Ç–±—Ä–∞–∫–æ–≤–∞—Ç—å" {{ 'selected' if ncr.Measures == '–û—Ç–±—Ä–∞–∫–æ–≤–∞—Ç—å' else '' }}>–û—Ç–±—Ä–∞–∫–æ–≤–∞—Ç—å</option>
                <option value="–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å" {{ 'selected' if ncr.Measures == '–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å' else '' }}>–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å</option>
                <option value="–î—Ä—É–≥–æ–µ" {{ 'selected' if ncr.Measures == '–î—Ä—É–≥–æ–µ' else '' }}>–î—Ä—É–≥–æ–µ</option>
            </select>
        </div>

        <div class="form-group">
            <label for="inspector_name_field">16. –§–ò–û –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞</label>
            <input type="text"
       name="inspector_name_field"
       value="{{ ncr.inspector_name_field }}"
       readonly>
        </div>
        

   <p>
    <strong>–°—Ç–∞—Ç—É—Å:</strong>
    {% if ncr.NCR_Status == '–ó–∞–∫—Ä—ã—Ç–æ' %}
        <span style="color:green;">‚úÖ –ó–∞–∫—Ä—ã—Ç–æ</span>
    {% else %}
        <span style="color:#b45309;">‚ö† –û—Ç–∫—Ä—ã—Ç–æ</span>
    {% endif %}
</p>
        

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏ -->
        <div class="row mb-3" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <div class="col-md-6">
                <label class="form-label" style="font-weight: bold;">üë®‚Äçüíº –°–æ–∑–¥–∞–ª:</label>
                <input type="text" class="form-control" value="{{ ncr.inspector_name }}" readonly>
            </div>
            <div class="col-md-6">
                <label class="form-label" style="font-weight: bold;">üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</label>
                <input type="text" class="form-control" value="{{ ncr.created_at }}" readonly>
            </div>
        </div>
        
        <hr>

        <h3>üì∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h3>

        {% if ncr.photos %}
<div style="display:flex; gap:15px; flex-wrap:wrap;">

    {% for photo in ncr.photos %}
    <div style="position:relative; display:inline-block;">

        <img src="{{ url_for('static', filename='uploads/ncr_photos/' ~ photo) }}"
             style="height:130px; border:1px solid #ccc; border-radius:4px;">

        <!-- ‚ùå –£–î–ê–õ–ï–ù–ò–ï –§–û–¢–û -->
        <button type="submit"
                formaction="{{ url_for('delete_ncr_photo', ncr_id=ncr.id, filename=photo) }}"
                formmethod="POST"
                class="btn btn-danger btn-sm"
                style="
                    position:absolute;
                    top:5px;
                    right:5px;
                    padding:2px 6px;
                    font-size:12px;
                "
                title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">
            ‚ùå
        </button>

    </div>
    {% endfor %}

</div>
{% endif %}



        <h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ</h4>
        <input type="file" name="photos" multiple accept="image/*">

        <br><br>
        <hr>
        

<h4>üìé –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∫–∞–Ω NCR (SharePoint)</h4>

<div class="form-group">
    <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</label>
    <input type="url"
           name="signed_scan_url"
           class="form-control"
           placeholder="https://company.sharepoint.com/..."
           value="{{ ncr.signed_scan_url or '' }}">
<small class="text-muted">
    –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ SharePoint
</small>
</div>
{% if ncr.signed_scan_url %}
    <button type="submit"
            name="remove_signed_scan"
            value="1"
            class="btn btn-sm btn-outline-danger"
            style="margin-top:8px;">
        ‚ùå –£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É
    </button>
{% endif %}
{% if ncr.NCR_Status != '–ó–∞–∫—Ä—ã—Ç–æ' and ncr.signed_scan_url %}
<button type="submit"
        name="close_ncr"
        value="1"
        class="btn btn-danger"
        style="margin-top:10px;"
        onclick="return confirm('‚ö†Ô∏è –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è NCR —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ?');">
    üîí –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ
</button>
{% endif %}
{% if ncr.signed_scan_url %}
    <p style="margin-top:6px;">
        ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω:
        <a href="{{ ncr.signed_scan_url }}" target="_blank">
            –û—Ç–∫—Ä—ã—Ç—å
        </a><br>
        <small>
            {{ ncr.signed_scan_uploaded_by }}
            ¬∑ {{ ncr.signed_scan_uploaded_at }}
        </small>
    </p>
    
{% else %}
    <p style="color:#b45309;">‚ùó –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∫–∞–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
{% endif %}
        <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <a href="{{ url_for('ncr_list') }}" class="btn btn-secondary">üîô –ù–∞–∑–∞–¥</a>
<a href="{{ url_for('print_ncr', ncr_id=ncr.id) }}"
   target="_blank"
   class="btn btn-outline-secondary">
   üñ®Ô∏è –ü–µ—á–∞—Ç—å NCR
   
</a>
    </form>



</div>
{% endblock %}